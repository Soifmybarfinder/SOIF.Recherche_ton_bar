<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOIF MyBarFinder - Montpellier</title>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Q86SEH0EQJ"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-Q86SEH0EQJ');
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a0f24 0%, #2d1b3d 100%);
            min-height: 100vh;
            color: #fff;
        }
        
        .container { 
            max-width: 500px; 
            margin: 0 auto; 
            background: #1a0f24; 
            min-height: 100vh; 
        }
        
        .header {
            background: linear-gradient(135deg, #4a0e4e 0%, #81236e 40%, #ab2567 70%, #ff006e 100%);
            padding: 40px 24px 30px;
            text-align: center;
        }
        
        .header h1 { 
            font-size: 48px; 
            font-weight: 200; 
            letter-spacing: 12px; 
            margin-bottom: 8px; 
        }
        
        .header p { font-size: 14px; opacity: 0.9; }
        
        .tabs {
            display: flex;
            background: #21152f;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .tab {
            flex: 1; 
            padding: 16px; 
            text-align: center; 
            background: transparent; 
            border: none;
            color: rgba(255, 255, 255, 0.5); 
            font-weight: 600; 
            cursor: pointer; 
            font-size: 14px;
            transition: all 0.3s; 
            position: relative;
        }
        
        .tab.active { color: #fff; }
        
        .tab.active::after {
            content: ''; 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            height: 3px;
            background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
        }
        
        .content { padding: 24px; display: none; }
        .content.active { display: block; }
        
        .btn-primary {
            width: 100%; 
            padding: 16px; 
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white; 
            border: none; 
            border-radius: 12px; 
            font-weight: 700; 
            font-size: 16px;
            cursor: pointer; 
            margin-bottom: 16px; 
            transition: transform 0.2s;
        }
        
        .btn-primary:hover { transform: translateY(-2px); }
        
        .btn-secondary {
            width: 100%; 
            padding: 16px; 
            background: rgba(255,255,255,0.1); 
            color: white;
            border: none; 
            border-radius: 12px; 
            font-weight: 700; 
            font-size: 16px;
            cursor: pointer; 
            margin-bottom: 16px;
        }
        
        .btn-grid {
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-bottom: 20px;
        }
        
        .form-group { margin-bottom: 20px; }
        
        .form-label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            font-size: 14px; 
        }
        
        .form-input {
            width: 100%; 
            padding: 12px 16px; 
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1); 
            background: rgba(255, 255, 255, 0.05);
            color: white; 
            font-size: 14px;
        }
        
        .form-input:focus { 
            outline: none; 
            border-color: #ff8e8e; 
        }
        
        .form-input::placeholder { color: rgba(255, 255, 255, 0.4); }
        
        .category { margin-bottom: 25px; }
        
        .category-title {
            font-weight: 700; 
            font-size: 15px; 
            margin-bottom: 12px; 
            color: #ff8e8e;
            padding: 8px 0; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .add-filter-btn {
            background: rgba(255, 107, 107, 0.2);
            color: #ff8e8e;
            border: 1px solid rgba(255, 107, 107, 0.3);
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .add-filter-btn:hover {
            background: rgba(255, 107, 107, 0.3);
        }
        
        .filter-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 8px; 
        }
        
        .filter-item {
            display: flex; 
            align-items: center; 
            gap: 8px; 
            padding: 10px;
            background: rgba(255, 255, 255, 0.03); 
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.08); 
            cursor: pointer; 
            transition: all 0.2s;
            position: relative;
        }
        
        .filter-item:hover { background: rgba(255, 255, 255, 0.08); }
        
        .filter-item.active {
            background: rgba(255, 107, 107, 0.3); 
            border-color: rgba(255, 107, 107, 0.5);
        }
        
        .filter-item.custom {
            border-color: rgba(78, 204, 163, 0.5);
        }
        
        .filter-item input[type="checkbox"] { 
            width: 18px; 
            height: 18px; 
            cursor: pointer; 
        }
        
        .filter-item label { 
            font-size: 13px; 
            cursor: pointer; 
            flex: 1; 
        }
        
        .delete-filter-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(231, 76, 60, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .filter-item.custom:hover .delete-filter-btn {
            display: flex;
        }
        
        .bar-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            border-radius: 16px; 
            padding: 20px; 
            border: 1px solid rgba(255, 255, 255, 0.08);
            margin-bottom: 16px; 
            transition: all 0.3s;
        }
        
        .bar-card:hover {
            transform: translateY(-4px); 
            border-color: rgba(255, 107, 107, 0.3);
            box-shadow: 0 12px 24px rgba(255, 107, 107, 0.15);
        }
        
        .bar-name { font-size: 18px; font-weight: 700; margin-bottom: 6px; }
        .bar-type { font-size: 13px; color: #ff8e8e; margin-bottom: 8px; }
        .bar-address { font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-bottom: 12px; }
        .bar-features { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
        
        .feature-badge {
            background: rgba(255, 107, 107, 0.15); 
            color: #ff8e8e; 
            padding: 4px 10px;
            border-radius: 6px; 
            font-size: 11px; 
            font-weight: 600;
        }
        
        .search-input {
            width: 100%; 
            padding: 14px 16px; 
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1); 
            background: rgba(255, 255, 255, 0.05);
            color: white; 
            font-size: 14px; 
            margin-bottom: 20px;
        }
        
        .search-input:focus { outline: none; border-color: #ff8e8e; }
        .search-input::placeholder { color: rgba(255, 255, 255, 0.4); }
        
        .search-filter-item {
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.03); 
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.08); 
            cursor: pointer; 
            transition: all 0.2s;
            margin: 4px; 
            font-size: 13px;
        }
        
        .search-filter-item:hover { background: rgba(255, 255, 255, 0.08); }
        
        .search-filter-item.active {
            background: rgba(255, 107, 107, 0.3); 
            border-color: rgba(255, 107, 107, 0.5);
        }
        
        .search-filter-item.custom {
            border-color: rgba(78, 204, 163, 0.5);
        }
        
        .selected-filters {
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            margin-bottom: 20px; 
            min-height: 40px;
            padding: 12px; 
            border-radius: 12px; 
            background: rgba(255, 255, 255, 0.03);
        }
        
        .selected-filter-tag {
            display: flex; 
            align-items: center; 
            gap: 6px; 
            padding: 6px 12px;
            background: rgba(255, 107, 107, 0.3); 
            border-radius: 6px; 
            font-size: 12px; 
            font-weight: 600;
        }
        
        .filter-remove {
            background: none; 
            border: none; 
            color: white; 
            cursor: pointer; 
            font-size: 16px;
            line-height: 1; 
            padding: 0; 
            width: 16px; 
            height: 16px;
        }
        
        .notification {
            position: fixed; 
            top: 20px; 
            right: 20px; 
            padding: 14px 20px;
            background: linear-gradient(135deg, #4ecca3, #3eb489); 
            color: white;
            border-radius: 12px; 
            font-weight: 600; 
            box-shadow: 0 8px 20px rgba(78, 204, 163, 0.4);
            animation: slideIn 0.3s; 
            z-index: 2000; 
            max-width: 300px;
        }
        
        .notification.error {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .btn-actions { display: flex; gap: 10px; margin-top: 15px; }
        
        .btn-edit, .btn-delete {
            flex: 1; 
            padding: 10px; 
            border: none; 
            border-radius: 8px; 
            font-weight: 600;
            cursor: pointer; 
            font-size: 13px;
        }
        
        .btn-edit { background: rgba(78, 204, 163, 0.2); color: #4ecca3; }
        .btn-delete { background: rgba(231, 76, 60, 0.2); color: #ff6b6b; }
        
        .empty-state { 
            text-align: center; 
            padding: 60px 20px; 
            color: rgba(255, 255, 255, 0.4); 
        }
        
        .modal {
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0;
            background: rgba(0, 0, 0, 0.8); 
            z-index: 3000;
            display: flex; 
            align-items: center; 
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #21152f, #1a0f24);
            border-radius: 16px; 
            max-width: 500px; 
            width: 100%;
            padding: 24px; 
            border: 2px solid rgba(255, 107, 107, 0.3);
        }
        
        .modal h2 {
            margin-bottom: 20px; 
            color: #ff8e8e; 
            font-size: 24px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SOIF</h1>
            <p>MyBarFinder - Montpellier (<span id="totalBars">98</span> bars)</p>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="fiche">📝 Fiche Bar</button>
            <button class="tab" data-tab="recherche">🔍 Recherche</button>
        </div>

        <div id="fiche-content" class="content active">
            <button class="btn-primary" id="newBarBtn">+ Ajouter un nouveau bar</button>
            
            <div class="btn-grid">
                <button class="btn-secondary" id="exportBtn">📥 Exporter</button>
                <button class="btn-secondary" id="importBtn">📤 Importer</button>
            </div>
            
            <button class="btn-secondary" id="resetBtn">🔄 Réinitialiser</button>
            
            <input type="file" id="fileInput" accept=".json" style="display: none;">
            
            <div id="barFormContainer" style="display: none;">
                <h3 style="margin-bottom: 20px; font-size: 20px;">Informations du bar</h3>
                
                <div class="form-group">
                    <label class="form-label">Nom du bar *</label>
                    <input type="text" class="form-input" id="barName" placeholder="Ex: Le Rockstore">
                </div>
                <div class="form-group">
                    <label class="form-label">Type *</label>
                    <input type="text" class="form-input" id="barType" placeholder="Ex: Bar Rock">
                </div>
                <div class="form-group">
                    <label class="form-label">Adresse *</label>
                    <input type="text" class="form-input" id="barAddress" placeholder="Ex: 20 Rue de Verdun, 34000 Montpellier">
                </div>
                <div class="form-group">
                    <label class="form-label">Distance à la Comédie (km)</label>
                    <input type="number" step="0.1" class="form-input" id="barDistance" placeholder="0.5">
                </div>

                <div class="filters-section">
                    <h3 style="margin-bottom: 15px; font-size: 18px;">Caractéristiques</h3>
                    <div id="formFiltersContainer"></div>
                </div>

                <button class="btn-primary" id="saveBtn">Enregistrer le bar</button>
                <button class="btn-secondary" id="cancelBtn">Annuler</button>
            </div>

            <div id="barsList">
                <h3 style="margin-bottom: 15px; font-size: 18px;">Bars enregistrés (<span id="barsCount">98</span>)</h3>
                <div id="barsListContainer"></div>
            </div>
        </div>

        <div id="recherche-content" class="content">
            <input type="text" class="search-input" id="searchInput" placeholder="🔍 Rechercher par nom, type ou adresse">
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn-primary" id="surpriseMoiBtn" style="background: linear-gradient(135deg, #ff006e, #ab2567); flex: 1;">
                    🎲 Surprends-moi !
                </button>
                <button class="btn-primary" id="addFilterSearchBtn" style="background: linear-gradient(135deg, #4ecca3, #3eb489); flex: 1;">
                    ➕ Ajouter un filtre
                </button>
            </div>
            
            <div class="selected-filters" id="selectedFilters"></div>

            <div class="filters-search-section">
                <h3 style="font-size: 16px; margin-bottom: 15px; color: #ff8e8e;">Tous les filtres</h3>
                <div id="searchFiltersContainer"></div>
            </div>

            <div style="margin-top: 30px;">
                <h3 style="margin-bottom: 15px; font-size: 18px;">Résultats (<span id="resultCount">0</span>)</h3>
                <div id="searchResults"></div>
            </div>
        </div>
    </div>

    <script>
        // FILTRES ORGANISÉS - LISTE COMPLÈTE
        const FILTERS_ORDER = {
            'caracteristiques': [
                {id:'terrasse',label:'☀️ Terrasse'},
                {id:'wifi',label:'📶 WiFi'},
                {id:'happy_hour',label:'🥂 Happy Hour'},
                {id:'ouvert_maintenant',label:'✅ Ouvert maintenant'},
                {id:'jeux_societe',label:'🎲 Jeux de société'},
                {id:'petanque',label:'🎯 Pétanque'},
                {id:'billard',label:'🎱 Billard'},
                {id:'ecrans_tv',label:'📺 Écrans TV'},
                {id:'climatise',label:'❄️ Climatisé'},
                {id:'chauffage_exterieur',label:'🔥 Chauffage extérieur'},
                {id:'parking',label:'🅿️ Parking'},
                {id:'decoration_vintage',label:'🕰️ Déco vintage'},
                {id:'jardin',label:'🌳 Jardin'},
                {id:'vue_ville',label:'🏙️ Vue ville'},
                {id:'vue_mer',label:'🌊 Vue mer'}
            ],
            'quartiers': [
                {id:'ecusson',label:'🛡️ Écusson'},
                {id:'antigone',label:'🏛️ Antigone'},
                {id:'comedie',label:'🎭 Comédie'},
                {id:'gare',label:'🚂 Gare'},
                {id:'beaux_arts',label:'🎨 Beaux-Arts'},
                {id:'port_marianne',label:'⚓ Port Marianne'},
                {id:'rives_lez',label:'🏞️ Rives du Lez'},
                {id:'hopitaux_fac',label:'🏫 Hôpitaux-Facultés'},
                {id:'peyrou',label:'🏰 Peyrou'},
                {id:'plage',label:'🏖️ Plage'},
                {id:'figuerolles',label:'🏘️ Figuerolles'},
                {id:'boutonnet',label:'🌳 Boutonnet'},
                {id:'lattes',label:'🏖️ Lattes'}
            ],
            'nourriture': [
                {id:'planches',label:'🧀 Planches'},
                {id:'tapas',label:'🥘 Tapas'},
                {id:'vegan',label:'🌱 Végan'},
                {id:'vegetarien',label:'🥦 Végétarien'},
                {id:'gluten_free',label:'🌾 Sans gluten'},
                {id:'burgers',label:'🍔 Burgers'},
                {id:'carte_complete',label:'📋 Carte complète'},
                {id:'menus',label:'📜 Menus'},
                {id:'brunch',label:'🥐 Brunch'},
                {id:'pizzas',label:'🍕 Pizzas'},
                {id:'snacking',label:'🥪 Snacking'}
            ],
            'types': [
                {id:'bar_bieres',label:'🍺 Bar à bières'},
                {id:'bar_vins',label:'🍷 Bar à vins'},
                {id:'bar_cocktails',label:'🍸 Bar à cocktails'},
                {id:'pub',label:'🏴󠁧󠁢󠁥󠁮󠁧󠁿 Pub'},
                {id:'brasserie',label:'🍻 Brasserie'},
                {id:'cave_vin',label:'🍇 Cave à vin'},
                {id:'guinguette',label:'🪕 Guinguette'},
                {id:'speakeasy',label:'🤫 Speakeasy'},
                {id:'sport_bar',label:'⚽ Sports bar'},
                {id:'rooftop',label:'🏙️ Rooftop'},
                {id:'lounge',label:'🛋️ Lounge'},
                {id:'boite_club',label:'💃 Boîte/Club'},
                {id:'cafe',label:'☕ Café'}
            ],
            'boissons': [
                {id:'cocktails_signature',label:'🍸 Cocktails'},
                {id:'vins_naturels',label:'🍷 Vins'},
                {id:'bieres_artisanales',label:'🍺 Bières'},
                {id:'craft',label:'🍻 Craft'},
                {id:'whiskies',label:'🥃 Whiskies'},
                {id:'rhum',label:'🏝️ Rhums'},
                {id:'gin',label:'🌿 Gins'},
                {id:'champagne',label:'🍾 Champagne'},
                {id:'sans_alcool',label:'🧃 Sans alcool'},
                {id:'mocktails',label:'🥤 Mocktails'},
                {id:'bieres_locales',label:'🍺 Bières locales'},
                {id:'spiritueux',label:'🥃 Spiritueux'},
                {id:'shots',label:'🥃 Shots'}
            ],
            'ensoleillement': [
                {id:'jamais',label:'🌑 Jamais'},
                {id:'matin',label:'🌅 Matin'},
                {id:'midi',label:'🌞 Midi'},
                {id:'apres_midi',label:'🌇 Après-midi'},
                {id:'soir',label:'🌆 Soir'},
                {id:'terrasse_ensoleillee',label:'☀️ Terrasse ensoleillée'},
                {id:'terrasse_ombragee',label:'🌳 Terrasse ombragée'}
            ],
            'clientele': [
                {id:'18_25',label:'🧑 18-25 ans'},
                {id:'25_35',label:'👨 25-35 ans'},
                {id:'35_50',label:'👩 35-50 ans'},
                {id:'50_plus',label:'🧓 50+ ans'},
                {id:'tous_ages',label:'👪 Tous âges'},
                {id:'etudiants',label:'🎓 Étudiants'},
                {id:'business',label:'💼 Business'}
            ],
            'musiques': [
                {id:'rock',label:'🎸 Rock'},
                {id:'pop',label:'🎤 Pop'},
                {id:'jazz',label:'🎷 Jazz'},
                {id:'lounge_music',label:'🎹 Lounge'},
                {id:'electro',label:'🎧 Électro'},
                {id:'techno',label:'💿 Techno'},
                {id:'hip_hop',label:'🎙️ Hip-Hop'},
                {id:'indie',label:'🎵 Indie'},
                {id:'classique',label:'🎻 Classique'},
                {id:'variete',label:'📻 Variété'},
                {id:'chanson_francaise',label:'🇫🇷 Chanson française'},
                {id:'metal',label:'🤘 Metal'},
                {id:'disco',label:'🪩 Disco'},
                {id:'latino',label:'🕺 Latino'}
            ],
            'service': [
                {id:'chic',label:'✨ Chic'},
                {id:'familial',label:'👨‍👩‍👧‍👦 Familial'},
                {id:'decontracte',label:'😎 Décontracté'},
                {id:'amical',label:'🤝 Amical'},
                {id:'rapide',label:'⚡ Rapide'},
                {id:'attentionne',label:'🤗 Attentionné'},
                {id:'convivial',label:'🤗 Convivial'}
            ],
            'evenements': [
                {id:'karaoke',label:'🎤 Karaoké'},
                {id:'scene_ouverte',label:'🎭 Scène ouverte'},
                {id:'stand_up',label:'🎪 Stand-up'},
                {id:'dj_set',label:'🎧 DJ Set'},
                {id:'concerts',label:'🎵 Concerts'},
                {id:'quiz',label:'❓ Quiz'},
                {id:'retransmissions_sport',label:'📺 Retransmissions sport'},
                {id:'degustations',label:'🍷 Dégustations'},
                {id:'cours_cocktails',label:'🍹 Cours de cocktails'},
                {id:'sport_tv',label:'⚽ Sport TV'}
            ],
            'parfait_pour': [
                {id:'couples',label:'❤️ Couples'},
                {id:'famille_enfants',label:'👨‍👩‍👧 Famille avec enfants'},
                {id:'groupe_petit',label:'👤 Groupe < 5'},
                {id:'groupe_moyen',label:'👥 Groupe 5-10'},
                {id:'groupe_grand',label:'👨‍👩‍👧‍👦 Groupe > 10'},
                {id:'evenements_prives',label:'🎊 Événements privés'},
                {id:'afterwork',label:'💼 Afterwork'},
                {id:'anniversaire',label:'🎂 Anniversaire'},
                {id:'romantique',label:'❤️ Romantique'},
                {id:'festif',label:'🎉 Festif'}
            ],
            'assise': [
                {id:'canapes',label:'🛋️ Canapés'},
                {id:'bancs',label:'🪑 Bancs'},
                {id:'mange_debout',label:'🧍 Mange-debout'},
                {id:'tables',label:'🍽️ Tables'},
                {id:'comptoir',label:'🧇 Comptoir'},
                {id:'poufs',label:'💺 Poufs'},
                {id:'fauteuils',label:'🪒 Fauteuils'},
                {id:'jeux',label:'🎲 Jeux'},
                {id:'babyfoot',label:'⚽ Babyfoot'},
                {id:'flechettes',label:'🎯 Fléchettes'}
            ],
            'ambiances': [
                {id:'cosy',label:'🛋️ Cosy'},
                {id:'tendance',label:'✨ Tendance'},
                {id:'afterwork_ambiance',label:'💼 Afterwork'},
                {id:'romantique_ambiance',label:'❤️ Romantique'},
                {id:'sport',label:'⚽ Sport'},
                {id:'festif_ambiance',label:'🎉 Festif'},
                {id:'calme',label:'🧘 Calme'},
                {id:'anime',label:'💃 Animé'},
                {id:'intime',label:'🤫 Intime'},
                {id:'decontracte',label:'👕 Décontracté'},
                {id:'alternatif',label:'🎸 Alternatif'},
                {id:'underground',label:'🌑 Underground'},
                {id:'branche',label:'😎 Branché'},
                {id:'dancefloor',label:'💃 Dancefloor'},
                {id:'tropical',label:'🌴 Tropical'}
            ],
            'acces_pmr': [
                {id:'plain_pied',label:'🚪 Accès de plain-pied'},
                {id:'rampe_acces',label:'📶 Rampe d\'accès'},
                {id:'ascenseur',label:'🔼 Ascenseur'},
                {id:'toilettes_adaptees',label:'🚻 Toilettes adaptées'},
                {id:'personnel_forme',label:'👥 Personnel formé'},
                {id:'places_reservees',label:'🪑 Places réservées'}
            ]
        };

        // BASE DE DONNÉES - 98 BARS
        const BARS_DATA = [
            {"id":1,"name":"Le Alhambra Taberna","type":"Bar latino","address":"Rue Alexandre Cabanel, 34000 Montpellier","distance":0.3,"features":["bar_cocktails","festif","ecusson","latino","dancefloor"]},
            {"id":2,"name":"L'Antirouille","type":"Bar Concert","address":"12 Rue Anatole-France, 34000 Montpellier","distance":0.8,"features":["indie","concerts","alternatif","ecusson","festif","rock"]},
            {"id":3,"name":"L'Arbre Blanc","type":"Bar rooftop","address":"Avenue Raymond Dugrand, 34000 Montpellier","distance":1.2,"features":["rooftop","vue_ville","chic","bar_cocktails","port_marianne"]},
            {"id":4,"name":"L'Australian Café","type":"Pub australien","address":"108 Rue de Rhodes, 34000 Montpellier","distance":1.3,"features":["pub","bar_bieres","ecusson","sport_tv","brunch"]},
            {"id":5,"name":"La Barbote","type":"Bar microbrasserie","address":"1 Rue des Deux Ponts, 34000 Montpellier","distance":2.5,"features":["bar_bieres","terrasse_ensoleillee","jardin","calme","vue_ville"]},
            {"id":6,"name":"Barberousse","type":"Pub pirate","address":"6 Rue Boussairolles, 34000 Montpellier","distance":0.4,"features":["rhum","festif","ecusson","pub","decoration_vintage","shots"]},
            {"id":7,"name":"Le Barri","type":"Bar","address":"4 Boulevard Louis Blanc, 34000 Montpellier","distance":0.5,"features":["ecusson","convivial","bar_cocktails","terrasse"]},
            {"id":8,"name":"The Beehive","type":"Pub","address":"15 Rue du Plan d'Agde, 34000 Montpellier","distance":0.4,"features":["pub","bar_bieres","ecusson","convivial","terrasse"]},
            {"id":9,"name":"Le BelAmour","type":"Bar restaurant","address":"1 Rue Louis Lumière, 34970 Lattes","distance":3.5,"features":["lattes","terrasse","bar_vins","tapas","romantique"]},
            {"id":10,"name":"Le Berthom","type":"Bar à bières","address":"5 Rue Boussairolles, 34000 Montpellier","distance":0.1,"features":["bar_bieres","bieres_artisanales","ecusson","convivial","planches"]},
            {"id":11,"name":"The Black Sheep","type":"Pub alternatif","address":"21 Boulevard Louis Blanc, 34000 Montpellier","distance":1.0,"features":["concerts","bar_bieres","alternatif","beaux_arts","pub"]},
            {"id":12,"name":"Le Black Out","type":"Bar rock","address":"6 Rue de la Vieille Intendance, 34000 Montpellier","distance":0.6,"features":["rock","concerts","underground","ecusson","festif"]},
            {"id":13,"name":"Le Bockale","type":"Bar à bières","address":"2 Rue de la République, 34000 Montpellier","distance":0.8,"features":["bar_bieres","bieres_artisanales","convivial","terrasse"]},
            {"id":14,"name":"Le Bonsoir","type":"Bar lounge","address":"6 Rue de la Croix d'Or, 34000 Montpellier","distance":0.4,"features":["lounge","bar_cocktails","ecusson","cosy","romantique"]},
            {"id":15,"name":"Le Broc Café","type":"Café bar","address":"Rue du Faubourg de Nîmes, 34000 Montpellier","distance":1.3,"features":["cafe","terrasse","convivial","brunch","calme"]},
            {"id":16,"name":"Le Burnoutbar","type":"Bar e-sport","address":"60 Bis Avenue du Pont Juvénal, 34000 Montpellier","distance":1.8,"features":["jeux","bar_cocktails","antigone","convivial","jeux_societe"]},
            {"id":17,"name":"Le Café Joseph","type":"Brasserie","address":"Place Jean Jaurès, 34000 Montpellier","distance":0.3,"features":["terrasse","bar_cocktails","ecusson","branche","brasserie"]},
            {"id":18,"name":"Le Café Joyeux","type":"Café solidaire","address":"Place Alexandre Laissac, 34000 Montpellier","distance":0.1,"features":["cafe","terrasse","convivial","brunch"]},
            {"id":19,"name":"Le Café Jules","type":"Brasserie","address":"2 Place de la Comédie, 34000 Montpellier","distance":0.1,"features":["terrasse","comedie","cafe","branche","vue_ville","brasserie"]},
            {"id":20,"name":"Le Café Latitude","type":"Café culturel","address":"Rue de la Méditerranée, 34000 Montpellier","distance":1.5,"features":["cafe","concerts","terrasse","convivial","alternatif"]},
            {"id":21,"name":"Le Café Panis","type":"Café brasserie","address":"Boulevard du Jeu de Paume, 34000 Montpellier","distance":0.4,"features":["cafe","brasserie","terrasse","comedie","brunch"]},
            {"id":22,"name":"Le Café Paume","type":"Café bar","address":"Boulevard du Jeu de Paume, 34000 Montpellier","distance":0.3,"features":["cafe","terrasse","ecusson","calme","wifi"]},
            {"id":23,"name":"Le Café Riche","type":"Brasserie historique","address":"8 Place de la Comédie, 34000 Montpellier","distance":0.1,"features":["terrasse","comedie","cafe","decoration_vintage","brasserie"]},
            {"id":24,"name":"Chez Canaille","type":"Bar restaurant","address":"5 Place du Petit Scel, 34000 Montpellier","distance":0.3,"features":["bar_vins","tapas","terrasse","convivial","cosy"]},
            {"id":25,"name":"Le Carolan's","type":"Pub irlandais","address":"Place Saint-Côme, 34000 Montpellier","distance":0.2,"features":["pub","bar_bieres","comedie","sport_tv","convivial"]},
            {"id":26,"name":"La Casa Cubana","type":"Bar latino","address":"2 Place de la Chapelle, 34000 Montpellier","distance":0.6,"features":["bar_cocktails","latino","dancefloor","ecusson","festif"]},
            {"id":27,"name":"La Chistera","type":"Pub","address":"2 Bis Rue d'Obilion, 34000 Montpellier","distance":0.1,"features":["bar_bieres","bieres_artisanales","pub","comedie","convivial","karaoke"]},
            {"id":28,"name":"La Cigale","type":"Bar brasserie","address":"7 Boulevard des Arceaux, 34000 Montpellier","distance":0.6,"features":["brasserie","terrasse","comedie","cafe","vue_ville"]},
            {"id":29,"name":"Le Clandestin","type":"Bar speakeasy","address":"18 Rue de la Valfrère, 34000 Montpellier","distance":0.3,"features":["speakeasy","bar_cocktails","ecusson","chic","cosy"]},
            {"id":30,"name":"Le Comptoir de l'Arc","type":"Café bar","address":"1 Place Lacanourgue, 34000 Montpellier","distance":0.9,"features":["terrasse","ecusson","cafe","vue_ville","calme"]},
            {"id":31,"name":"The Copperbar","type":"Pub moderne","address":"6 Rue de l'Université, 34000 Montpellier","distance":0.6,"features":["spiritueux","cosy","ecusson","pub","chic"]},
            {"id":32,"name":"Les Coulisses","type":"Bar lounge","address":"3-9 Rue Copé Cambes, 34000 Montpellier","distance":0.3,"features":["lounge","bar_cocktails","ecusson","cosy","chic"]},
            {"id":33,"name":"Le Coyot Bar","type":"Bar américain","address":"1348 Avenue de la Mer Raymond Dugrand, 34000 Montpellier","distance":1.5,"features":["bar_cocktails","terrasse","port_marianne","festif","burgers"]},
            {"id":34,"name":"Le Cubanito","type":"Bar latino","address":"13 Rue de Verdun, 34000 Montpellier","distance":0.8,"features":["latino","bar_cocktails","ecusson","festif","dancefloor"]},
            {"id":35,"name":"Le Discopathe","type":"Bar disco","address":"28 Rue du Faubourg du Courreau, 34000 Montpellier","distance":0.9,"features":["disco","dancefloor","festif","dj_set","figuerolles"]},
            {"id":36,"name":"La Distillerie","type":"Bar à cocktails","address":"67 Rue de l'Aiguillerie, 34000 Montpellier","distance":0.6,"features":["bar_cocktails","cocktails_signature","speakeasy","ecusson","chic"]},
            {"id":37,"name":"Le Dôme","type":"Bar élégant","address":"2 Rue du Grand Saint-Jean, 34000 Montpellier","distance":0.3,"features":["bar_cocktails","ecusson","lounge","chic","tendance"]},
            {"id":38,"name":"Le Drapeau Rouge","type":"Bar alternatif","address":"53 Rue du Faubourg Boutonnet, 34000 Montpellier","distance":1.3,"features":["alternatif","concerts","boutonnet","underground","convivial"]},
            {"id":39,"name":"La Dune","type":"Club","address":"Palavas-les-Flots, 34250","distance":12.0,"features":["boite_club","plage","terrasse_ensoleillee","vue_mer","festif","cocktails_signature"]},
            {"id":40,"name":"Les Enfants Rouges","type":"Bar restaurant","address":"3 Plan Duché, 34000 Montpellier","distance":0.5,"features":["ecusson","bar_cocktails","tapas","terrasse","branche"]},
            {"id":41,"name":"Le Fitzpatrick's","type":"Pub irlandais","address":"9 Place Saint-Côme, 34000 Montpellier","distance":0.2,"features":["sport_tv","bar_bieres","convivial","comedie","pub"]},
            {"id":42,"name":"Le Fizz","type":"Club","address":"Rue de Verdun, 34000 Montpellier","distance":0.9,"features":["boite_club","dancefloor","dj_set","electro","festif"]},
            {"id":43,"name":"La Fumerie","type":"Bar lounge","address":"Rue du Petit Saint-Jean, 34000 Montpellier","distance":0.5,"features":["lounge","bar_cocktails","ecusson","cosy","chic"]},
            {"id":44,"name":"Les Garçons","type":"Bar","address":"15 Rue des Sœurs Noires, 34000 Montpellier","distance":0.6,"features":["ecusson","convivial","bar_cocktails","decontracte","festif"]},
            {"id":45,"name":"Le Gazette Café","type":"Café culturel","address":"6 Rue Levat, 34000 Montpellier","distance":1.1,"features":["concerts","terrasse","cafe","convivial"]},
            {"id":46,"name":"Le Harts Bar","type":"Pub","address":"Rue de la Merci, 34000 Montpellier","distance":0.4,"features":["pub","bar_bieres","ecusson","sport_tv","convivial"]},
            {"id":47,"name":"Le Hopulus Brewpub","type":"Brasserie artisanale","address":"8 Rue Collot, 34000 Montpellier","distance":0.1,"features":["brasserie","bieres_artisanales","comedie","planches","snacking"]},
            {"id":48,"name":"Hossegor Bar","type":"Bar","address":"8 Rue de la Petite Loge, 34000 Montpellier","distance":0.3,"features":["bar_cocktails","festif","disco","comedie","decontracte"]},
            {"id":49,"name":"The Invader","type":"Bar geek","address":"5 Rue du Plan d'Agde, 34000 Montpellier","distance":0.5,"features":["jeux","bar_cocktails","ecusson","convivial","alternatif"]},
            {"id":50,"name":"La Jalade","type":"Bar nature","address":"10 Rue de la Jalade, 34000 Montpellier","distance":2.0,"features":["calme","terrasse_ombragee","jardin","cosy","decontracte"]},
            {"id":51,"name":"Un Bar et Jivay","type":"Bar étudiant","address":"Square de la Babote, 34000 Montpellier","distance":0.6,"features":["bar_bieres","convivial","ecusson","decontracte","festif"]},
            {"id":52,"name":"Le Jost","type":"Bar lounge","address":"8 Rue du Faubourg de la Saunerie, 34000 Montpellier","distance":0.7,"features":["bar_cocktails","cosy","figuerolles","lounge","tendance"]},
            {"id":53,"name":"Le Kaleido Bar","type":"Bar à cocktails","address":"2 Rue Jules Latreilhe, 34000 Montpellier","distance":0.3,"features":["bar_cocktails","terrasse","comedie","cafe","tapas","dj_set"]},
            {"id":54,"name":"Le Kiosque Verde Paradis","type":"Bar nature","address":"Quartier Beaux-Arts, 34000 Montpellier","distance":1.0,"features":["jardin","terrasse_ensoleillee","calme","bar_vins","beaux_arts"]},
            {"id":55,"name":"Le Madrediosa","type":"Bar latino","address":"Rue de la Loge, 34000 Montpellier","distance":0.3,"features":["latino","bar_cocktails","ecusson","festif","dancefloor"]},
            {"id":56,"name":"La Maison Fleurie","type":"Bar à cocktails","address":"Rue du Faubourg Figuerolles, 34000 Montpellier","distance":1.4,"features":["bar_cocktails","jardin","terrasse_ombragee","calme","cosy"]},
            {"id":57,"name":"Les Marchands","type":"Bar à vin","address":"8 Place Alexandre Laissac, 34000 Montpellier","distance":0.5,"features":["bar_vins","ecusson","cosy","planches","vins_naturels"]},
            {"id":58,"name":"Mi Barrio","type":"Bar latino","address":"Rue du Plan d'Agde, 34000 Montpellier","distance":0.4,"features":["latino","bar_cocktails","ecusson","festif","tapas"]},
            {"id":59,"name":"Le Mio Bar","type":"Bar à cocktails","address":"11 Rue des Balances, 34000 Montpellier","distance":0.4,"features":["bar_cocktails","gin","cocktails_signature","lounge","terrasse"]},
            {"id":60,"name":"Le Milk Club","type":"Club","address":"Rue Ferdinand Fabre, 34000 Montpellier","distance":1.0,"features":["boite_club","dancefloor","dj_set","festif","electro"]},
            {"id":61,"name":"Le Miranov","type":"Rooftop","address":"455 Avenue du Professeur Antonin Balmès, 34000 Montpellier","distance":2.5,"features":["rooftop","calme","cosy","snacking","convivial"]},
            {"id":62,"name":"Le Mosquito","type":"Bar latino","address":"1 Rue du Plan d'Agde, 34000 Montpellier","distance":0.4,"features":["bar_cocktails","latino","dancefloor","ecusson","festif","dj_set"]},
            {"id":63,"name":"La Muchacha","type":"Bar latino","address":"Rue de la Loge, 34000 Montpellier","distance":0.3,"features":["latino","bar_cocktails","ecusson","festif","convivial"]},
            {"id":64,"name":"Le Mustang","type":"Bar américain","address":"Rue du Grand Saint-Jean, 34000 Montpellier","distance":0.4,"features":["ecusson","bar_cocktails","festif","rock","convivial"]},
            {"id":65,"name":"La Notte","type":"Bar à vin","address":"Rue de l'Aiguillerie, 34000 Montpellier","distance":0.5,"features":["bar_vins","vins_naturels","ecusson","cosy","planches"]},
            {"id":66,"name":"Le Novelty","type":"Bar","address":"Rue de Verdun, 34000 Montpellier","distance":0.8,"features":["bar_cocktails","festif","convivial","ecusson"]},
            {"id":67,"name":"Le O'Sullivan","type":"Pub irlandais","address":"Boulevard du Jeu de Paume, 34000 Montpellier","distance":0.3,"features":["pub","bar_bieres","sport_tv","comedie","festif"]},
            {"id":68,"name":"Le Palace","type":"Club","address":"Rue de la République, 34000 Montpellier","distance":0.5,"features":["boite_club","dancefloor","dj_set","chic","festif"]},
            {"id":69,"name":"Palace Bar","type":"Bar à pastis","address":"Montpellier, 34000","distance":0.5,"features":["bar_cocktails","terrasse","pizzas","sport_tv","babyfoot","flechettes"]},
            {"id":70,"name":"La Pampa Sauvage","type":"Bar","address":"2400 Route de Pérols, 34970 Lattes","distance":5.0,"features":["bar_cocktails","snacking","disco","terrasse_ensoleillee","vue_ville"]},
            {"id":71,"name":"Papa Doble","type":"Bar à cocktails","address":"6 Rue du Petit Scel, 34000 Montpellier","distance":0.3,"features":["bar_cocktails","cocktails_signature","chic","ecusson","speakeasy","cosy"]},
            {"id":72,"name":"Le Parfum","type":"Bar à cocktails","address":"55 Rue de la Cavalerie, 34000 Montpellier","distance":1.0,"features":["bar_cocktails","cocktails_signature","cosy","chic","romantique"]},
            {"id":73,"name":"The Peacock","type":"Pub anglais","address":"Rue de la Merci, 34000 Montpellier","distance":0.4,"features":["pub","bar_bieres","ecusson","sport_tv","convivial"]},
            {"id":74,"name":"Café Pitot","type":"Café bar","address":"2 Place d'Aviler, 34000 Montpellier","distance":1.2,"features":["cafe","terrasse","calme","cosy","wifi"]},
            {"id":75,"name":"Plein Sud","type":"Bar restaurant","address":"Port Marianne, 34000 Montpellier","distance":2.0,"features":["terrasse_ensoleillee","bar_cocktails","port_marianne","vue_ville","brunch"]},
            {"id":76,"name":"Pousse Pas Mémée Dans La Vigne","type":"Bar à vin","address":"Rue de l'Aiguillerie, 34000 Montpellier","distance":0.5,"features":["bar_vins","vins_naturels","ecusson","convivial","planches"]},
            {"id":77,"name":"Le Rebuffy","type":"Bar chill","address":"3 Rue Rebuffy, 34000 Montpellier","distance":0.3,"features":["bar_cocktails","terrasse","ecusson","calme","cosy","decontracte"]},
            {"id":78,"name":"Le Redline","type":"Bar rock","address":"Rue de Verdun, 34000 Montpellier","distance":0.8,"features":["rock","concerts","underground","festif","metal"]},
            {"id":79,"name":"Le Réservoir","type":"Bar à bières","address":"55 Rue de Montels Saint-Pierre, 34070 Montpellier","distance":2.0,"features":["bar_bieres","bieres_artisanales","bieres_locales","quiz","karaoke"]},
            {"id":80,"name":"Le Rhum Runner","type":"Bar à rhum","address":"Rue des Trésoriers de France, 34000 Montpellier","distance":0.4,"features":["rhum","bar_cocktails","ecusson","festif","tropical"]},
            {"id":81,"name":"Le Rockstore","type":"Bar Rock / Concert","address":"20 Rue de Verdun, 34000 Montpellier","distance":0.8,"features":["concerts","rock","underground","ecusson","festif","metal"]},
            {"id":82,"name":"Le Saint Roch","type":"Bar","address":"Quartier Saint-Roch, 34000 Montpellier","distance":0.6,"features":["convivial","bar_bieres","terrasse","decontracte"]},
            {"id":83,"name":"Le Secco","type":"Bar à vin","address":"Rue de l'Aiguillerie, 34000 Montpellier","distance":0.5,"features":["bar_vins","vins_naturels","ecusson","cosy","planches","brunch","festif"]},
            {"id":84,"name":"The Shakespeare","type":"Pub anglais","address":"Rue de la Merci, 34000 Montpellier","distance":0.4,"features":["bieres_artisanales","pub","ecusson","terrasse","wifi","convivial"]},
            {"id":85,"name":"Les 3 Singes","type":"Bar concert","address":"Rue des Étuves, 34000 Montpellier","distance":0.4,"features":["concerts","rock","ecusson","alternatif","festif"]},
            {"id":86,"name":"Le Smash Bar","type":"Bar à cocktails","address":"Rue du Petit Saint-Jean, 34000 Montpellier","distance":0.5,"features":["bar_cocktails","cocktails_signature","ecusson","festif","tendance"]},
            {"id":87,"name":"Le St Roch","type":"Bar à tapas","address":"22 Rue du Petit Saint-Jean, 34000 Montpellier","distance":0.4,"features":["bar_vins","tapas","ecusson","convivial","cosy"]},
            {"id":88,"name":"Les Super Vedettes","type":"Bar concert","address":"4 Place des Beaux-Arts, 34000 Montpellier","distance":1.0,"features":["concerts","indie","alternatif","rock","festif","sport_tv","terrasse_ombragee"]},
            {"id":89,"name":"Le Tarbrew","type":"Bar à bières","address":"20 Rue du Docteur Pezat, 34000 Montpellier","distance":1.3,"features":["bar_bieres","bieres_artisanales","bieres_locales","terrasse","figuerolles","convivial","flechettes"]},
            {"id":90,"name":"La Terraza","type":"Bar terrasse","address":"Place de la Comédie, 34000 Montpellier","distance":0.1,"features":["terrasse","comedie","bar_cocktails","vue_ville","festif"]},
            {"id":91,"name":"Le Times","type":"Pub","address":"Rue de la Loge, 34000 Montpellier","distance":0.3,"features":["pub","bar_bieres","ecusson","sport_tv","convivial"]},
            {"id":92,"name":"Le Toit Toit Mon Toit","type":"Rooftop bar","address":"Antigone, 34000 Montpellier","distance":1.5,"features":["rooftop","vue_ville","terrasse_ensoleillee","bar_cocktails","chic"]},
            {"id":93,"name":"Le Trinque Fougasse","type":"Bar à vin","address":"1 Rue de la Galéra, 34000 Montpellier","distance":1.2,"features":["bar_vins","tapas","terrasse_ensoleillee","port_marianne","vins_naturels","planches"]},
            {"id":94,"name":"Le Triskel","type":"Bar breton","address":"Place Candolle, 34000 Montpellier","distance":0.5,"features":["bar_bieres","calme","ecusson","convivial"]},
            {"id":95,"name":"Le Tub","type":"Bar à cocktails","address":"6 Rue du Petit Scel, 34000 Montpellier","distance":0.3,"features":["bar_cocktails","chic","electro"]},
            {"id":96,"name":"Le V&B","type":"Bar à bières","address":"9 Allée du Levant, 34970 Lattes","distance":4.0,"features":["bar_bieres","bieres_artisanales","planches","convivial"]},
            {"id":97,"name":"Le Verre à Soi","type":"Bar à vin","address":"17 Rue Saint-Guilhem, 34000 Montpellier","distance":0.6,"features":["bar_vins","vins_naturels","ecusson","cosy","planches"]},
            {"id":98,"name":"Le VR à Vin","type":"Bar à vin","address":"468 Rue de la Croix Verte, 34090 Montpellier","distance":2.8,"features":["bar_vins","vins_naturels","boutonnet","cosy","planches"]}
        ];

        let bars = [];
        let editingBarId = null;
        let selectedSearchFilters = [];
        let customFilters = {};

        // INITIALISATION
        function init() {
            loadBars();
            generateFormFilters();
            generateSearchFilters();
            renderBarsList();
            updateSelectedFilters();
            performSearch();
            attachEvents();
        }

        function loadBars() {
            const saved = localStorage.getItem('soif_bars');
            if (saved) {
                bars = JSON.parse(saved);
            } else {
                bars = [...BARS_DATA];
            }
            bars = sortBarsByName(bars);
            
            const savedFilters = localStorage.getItem('soif_custom_filters');
            if (savedFilters) {
                customFilters = JSON.parse(savedFilters);
                Object.keys(customFilters).forEach(category => {
                    if (!FILTERS_ORDER[category]) {
                        FILTERS_ORDER[category] = [];
                    }
                    customFilters[category].forEach(filter => {
                        if (!FILTERS_ORDER[category].find(f => f.id === filter.id)) {
                            FILTERS_ORDER[category].push(filter);
                        }
                    });
                });
            }
            
            updateCounts();
        }

        function saveBars() {
            localStorage.setItem('soif_bars', JSON.stringify(bars));
        }

        function saveCustomFilters() {
            localStorage.setItem('soif_custom_filters', JSON.stringify(customFilters));
        }

        function removeArticle(name) {
            const articles = ['Le ', 'La ', 'Les ', "L'", 'The ', 'Chez ', 'Un '];
            for (let article of articles) {
                if (name.startsWith(article)) {
                    return name.substring(article.length);
                }
            }
            return name;
        }

        function sortBarsByName(barsArray) {
            return barsArray.sort((a, b) => {
                const nameA = removeArticle(a.name).toLowerCase();
                const nameB = removeArticle(b.name).toLowerCase();
                return nameA.localeCompare(nameB);
            });
        }

        function findFilterLabel(filterId) {
            for (const category in FILTERS_ORDER) {
                const filter = FILTERS_ORDER[category].find(f => f.id === filterId);
                if (filter) return filter.label;
            }
            return filterId;
        }

        // GÉNÉRATION DES FILTRES FORMULAIRE
        function generateFormFilters() {
            const container = document.getElementById('formFiltersContainer');
            container.innerHTML = '';
            
            Object.keys(FILTERS_ORDER).forEach(categoryKey => {
                const div = document.createElement('div');
                div.className = 'category';
                
                const title = document.createElement('div');
                title.className = 'category-title';
                title.innerHTML = `
                    <span>${categoryKey.replace(/_/g, ' ').toUpperCase()}</span>
                    <button class="add-filter-btn" data-category="${categoryKey}">+ Filtre</button>
                `;
                div.appendChild(title);
                
                const grid = document.createElement('div');
                grid.className = 'filter-grid';
                
                FILTERS_ORDER[categoryKey].forEach(filter => {
                    const item = document.createElement('div');
                    item.className = 'filter-item';
                    
                    const isCustom = customFilters[categoryKey] && 
                                    customFilters[categoryKey].find(f => f.id === filter.id);
                    if (isCustom) {
                        item.classList.add('custom');
                    }
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `form_${filter.id}`;
                    checkbox.value = filter.id;
                    
                    const label = document.createElement('label');
                    label.htmlFor = `form_${filter.id}`;
                    label.textContent = filter.label;
                    
                    checkbox.addEventListener('change', function() {
                        item.classList.toggle('active', this.checked);
                    });
                    
                    item.addEventListener('click', function(e) {
                        if (e.target !== checkbox && e.target !== label && !e.target.classList.contains('delete-filter-btn')) {
                            checkbox.checked = !checkbox.checked;
                            item.classList.toggle('active', checkbox.checked);
                        }
                    });
                    
                    item.appendChild(checkbox);
                    item.appendChild(label);
                    
                    if (isCustom) {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-filter-btn';
                        deleteBtn.innerHTML = '×';
                        deleteBtn.title = 'Supprimer ce filtre';
                        deleteBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            deleteCustomFilter(categoryKey, filter.id);
                        });
                        item.appendChild(deleteBtn);
                    }
                    
                    grid.appendChild(item);
                });
                
                div.appendChild(grid);
                container.appendChild(div);
            });
        }

        // GÉNÉRATION DES FILTRES RECHERCHE
        function generateSearchFilters() {
            const container = document.getElementById('searchFiltersContainer');
            container.innerHTML = '';
            
            Object.keys(FILTERS_ORDER).forEach(categoryKey => {
                const div = document.createElement('div');
                div.className = 'category';
                
                const title = document.createElement('div');
                title.className = 'category-title';
                title.textContent = categoryKey.replace(/_/g, ' ').toUpperCase();
                div.appendChild(title);
                
                const filtersDiv = document.createElement('div');
                filtersDiv.style.marginTop = '10px';
                
                FILTERS_ORDER[categoryKey].forEach(filter => {
                    const item = document.createElement('div');
                    item.className = 'search-filter-item';
                    item.dataset.filterId = filter.id;
                    item.textContent = filter.label;
                    
                    const isCustom = customFilters[categoryKey] && 
                                    customFilters[categoryKey].find(f => f.id === filter.id);
                    if (isCustom) {
                        item.classList.add('custom');
                    }
                    
                    item.addEventListener('click', function() {
                        toggleSearchFilter(filter.id);
                    });
                    
                    filtersDiv.appendChild(item);
                });
                
                div.appendChild(filtersDiv);
                container.appendChild(div);
            });
        }

        // RECHERCHE
        function toggleSearchFilter(filterId) {
            const index = selectedSearchFilters.indexOf(filterId);
            if (index > -1) {
                selectedSearchFilters.splice(index, 1);
            } else {
                selectedSearchFilters.push(filterId);
            }
            updateSearchFilterUI();
            updateSelectedFilters();
            performSearch();
        }

        function updateSearchFilterUI() {
            document.querySelectorAll('.search-filter-item').forEach(item => {
                const isActive = selectedSearchFilters.includes(item.dataset.filterId);
                item.classList.toggle('active', isActive);
            });
        }

        function updateSelectedFilters() {
            const container = document.getElementById('selectedFilters');
            container.innerHTML = '';
            
            if (selectedSearchFilters.length === 0) {
                container.innerHTML = '<span style="color: rgba(255,255,255,0.4); font-size: 13px;">Aucun filtre sélectionné</span>';
                return;
            }
            
            selectedSearchFilters.forEach(filterId => {
                const tag = document.createElement('div');
                tag.className = 'selected-filter-tag';
                
                const label = document.createElement('span');
                label.textContent = findFilterLabel(filterId);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'filter-remove';
                removeBtn.textContent = '×';
                removeBtn.addEventListener('click', () => toggleSearchFilter(filterId));
                
                tag.appendChild(label);
                tag.appendChild(removeBtn);
                container.appendChild(tag);
            });
        }

        function performSearch() {
            const searchQuery = document.getElementById('searchInput').value.trim().toLowerCase();
            let filtered = bars;
            
            if (searchQuery) {
                filtered = filtered.filter(bar => 
                    bar.name.toLowerCase().includes(searchQuery) ||
                    bar.type.toLowerCase().includes(searchQuery) ||
                    bar.address.toLowerCase().includes(searchQuery)
                );
                
                // Tracking recherche
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'search', {
                        'search_term': searchQuery,
                        'results_count': filtered.length
                    });
                }
            }
            
            if (selectedSearchFilters.length > 0) {
                filtered = filtered.filter(bar =>
                    selectedSearchFilters.every(filterId => bar.features.includes(filterId))
                );
                
                // Tracking utilisation filtres
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'filter_used', {
                        'event_category': 'engagement',
                        'filter_count': selectedSearchFilters.length
                    });
                }
            }
            
            renderSearchResults(filtered);
        }

        function renderSearchResults(filteredBars) {
            const container = document.getElementById('searchResults');
            const countEl = document.getElementById('resultCount');
            countEl.textContent = filteredBars.length;
            
            if (filteredBars.length === 0) {
                container.innerHTML = '<div class="empty-state">Aucun bar trouvé</div>';
                return;
            }
            
            container.innerHTML = '';
            filteredBars.forEach(bar => {
                const card = createBarCard(bar, false);
                container.appendChild(card);
            });
        }

        // CRÉATION CARTE BAR
        function createBarCard(bar, withActions = false) {
            const card = document.createElement('div');
            card.className = 'bar-card';
            
            const name = document.createElement('div');
            name.className = 'bar-name';
            name.textContent = bar.name;
            
            const type = document.createElement('div');
            type.className = 'bar-type';
            type.textContent = bar.type;
            
            const address = document.createElement('div');
            address.className = 'bar-address';
            address.textContent = `${bar.address} • ${bar.distance} km`;
            
            const features = document.createElement('div');
            features.className = 'bar-features';
            bar.features.slice(0, 8).forEach(f => {
                const badge = document.createElement('span');
                badge.className = 'feature-badge';
                badge.textContent = findFilterLabel(f);
                features.appendChild(badge);
            });
            if (bar.features.length > 8) {
                const more = document.createElement('span');
                more.className = 'feature-badge';
                more.textContent = `+${bar.features.length - 8}`;
                features.appendChild(more);
            }
            
            card.appendChild(name);
            card.appendChild(type);
            card.appendChild(address);
            card.appendChild(features);
            
            if (withActions) {
                const actions = document.createElement('div');
                actions.className = 'btn-actions';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'btn-edit';
                editBtn.textContent = '✏️ Modifier';
                editBtn.addEventListener('click', () => editBar(bar.id));
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-delete';
                deleteBtn.textContent = '🗑️ Supprimer';
                deleteBtn.addEventListener('click', () => deleteBar(bar.id));
                
                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);
                card.appendChild(actions);
            }
            
            return card;
        }

        // LISTE DES BARS
        function renderBarsList() {
            const container = document.getElementById('barsListContainer');
            container.innerHTML = '';
            
            if (bars.length === 0) {
                container.innerHTML = '<div class="empty-state">Aucun bar enregistré</div>';
                return;
            }
            
            bars.forEach(bar => {
                const card = createBarCard(bar, true);
                container.appendChild(card);
            });
        }

        // FORMULAIRE BAR
        function showNewBarForm() {
            editingBarId = null;
            document.getElementById('barFormContainer').style.display = 'block';
            document.getElementById('barsList').style.display = 'none';
            clearForm();
        }

        function cancelEdit() {
            document.getElementById('barFormContainer').style.display = 'none';
            document.getElementById('barsList').style.display = 'block';
            clearForm();
        }

        function clearForm() {
            document.getElementById('barName').value = '';
            document.getElementById('barType').value = '';
            document.getElementById('barAddress').value = '';
            document.getElementById('barDistance').value = '';
            
            document.querySelectorAll('#formFiltersContainer input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            document.querySelectorAll('#formFiltersContainer .filter-item').forEach(item => {
                item.classList.remove('active');
            });
        }

        function editBar(id) {
            const bar = bars.find(b => b.id === id);
            if (!bar) return;
            
            editingBarId = id;
            document.getElementById('barFormContainer').style.display = 'block';
            document.getElementById('barsList').style.display = 'none';
            
            document.getElementById('barName').value = bar.name;
            document.getElementById('barType').value = bar.type;
            document.getElementById('barAddress').value = bar.address;
            document.getElementById('barDistance').value = bar.distance;
            
            document.querySelectorAll('#formFiltersContainer input[type="checkbox"]').forEach(cb => {
                const isChecked = bar.features.includes(cb.value);
                cb.checked = isChecked;
                cb.closest('.filter-item').classList.toggle('active', isChecked);
            });
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function saveBar() {
            const name = document.getElementById('barName').value.trim();
            const type = document.getElementById('barType').value.trim();
            const address = document.getElementById('barAddress').value.trim();
            const distance = parseFloat(document.getElementById('barDistance').value) || 0;
            
            if (!name || !type || !address) {
                showNotification('⚠️ Remplissez tous les champs obligatoires', 'error');
                return;
            }
            
            const features = [];
            document.querySelectorAll('#formFiltersContainer input[type="checkbox"]:checked').forEach(cb => {
                features.push(cb.value);
            });
            
            if (editingBarId) {
                const index = bars.findIndex(b => b.id === editingBarId);
                if (index !== -1) {
                    bars[index] = { ...bars[index], name, type, address, distance, features };
                    showNotification('✅ Bar modifié !');
                }
            } else {
                const id = bars.length > 0 ? Math.max(...bars.map(b => b.id)) + 1 : 1;
                bars.push({ id, name, type, address, distance, features });
                showNotification('✅ Bar créé !');
            }
            
            bars = sortBarsByName(bars);
            saveBars();
            cancelEdit();
            renderBarsList();
            updateCounts();
        }

        function deleteBar(id) {
            const bar = bars.find(b => b.id === id);
            if (!bar) return;
            
            if (!confirm(`Supprimer "${bar.name}" ?\n\nCette action est irréversible.`)) {
                return;
            }
            
            bars = bars.filter(b => b.id !== id);
            saveBars();
            showNotification(`🗑️ "${bar.name}" supprimé`);
            renderBarsList();
            updateCounts();
        }

        // IMPORT/EXPORT
        function exportData() {
            const dataStr = JSON.stringify(bars, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            const date = new Date().toISOString().split('T')[0];
            link.download = `soif-bars-${date}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showNotification('✅ Fichier téléchargé avec succès !');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedBars = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedBars)) {
                        showNotification('❌ Fichier invalide', 'error');
                        return;
                    }
                    
                    const valid = importedBars.every(bar => 
                        bar.id && bar.name && bar.type && bar.address && 
                        bar.distance !== undefined && Array.isArray(bar.features)
                    );
                    
                    if (!valid) {
                        showNotification('❌ Format de données incorrect', 'error');
                        return;
                    }
                    
                    if (confirm(`📥 Importer ${importedBars.length} bars ?\n\nCela remplacera votre base actuelle.`)) {
                        bars = importedBars;
                        bars = sortBarsByName(bars);
                        saveBars();
                        renderBarsList();
                        updateCounts();
                        showNotification(`✅ ${importedBars.length} bars importés !`);
                    }
                } catch (error) {
                    showNotification('❌ Erreur de lecture du fichier', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function resetToOriginalData() {
            if (!confirm('⚠️ Réinitialiser avec les 98 bars authentiques ?\n\nToutes vos modifications seront perdues !')) {
                return;
            }
            localStorage.clear();
            bars = [...BARS_DATA];
            bars = sortBarsByName(bars);
            saveBars();
            renderBarsList();
            updateCounts();
            showNotification('✅ Base authentique de 98 bars chargée !');
        }

        // FILTRES PERSONNALISÉS
        function showAddFilterModal(categoryKey) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'addFilterModal';
            
            const content = document.createElement('div');
            content.className = 'modal-content';
            
            let html = '<h2>➕ Ajouter un filtre personnalisé</h2>';
            
            html += '<div class="form-group">';
            html += '<label class="form-label">Catégorie *</label>';
            
            if (categoryKey) {
                // Si appelé depuis le formulaire avec catégorie pré-remplie
                html += `<input type="text" class="form-input" id="filterCategoryDisplay" value="${categoryKey.replace(/_/g, ' ').toUpperCase()}" disabled>`;
                html += `<input type="hidden" id="filterCategory" value="${categoryKey}">`;
            } else {
                // Si appelé depuis la recherche - sélection de catégorie
                html += '<select class="form-input" id="filterCategory" style="cursor: pointer;">';
                html += '<option value="">-- Choisir une catégorie --</option>';
                Object.keys(FILTERS_ORDER).forEach(key => {
                    const label = key.replace(/_/g, ' ').toUpperCase();
                    html += `<option value="${key}">${label}</option>`;
                });
                html += '</select>';
            }
            html += '</div>';
            
            html += '<div class="form-group">';
            html += '<label class="form-label">Emoji (optionnel)</label>';
            html += '<input type="text" class="form-input" id="filterEmoji" placeholder="🍺" maxlength="2">';
            html += '</div>';
            
            html += '<div class="form-group">';
            html += '<label class="form-label">Nom du filtre *</label>';
            html += '<input type="text" class="form-input" id="filterName" placeholder="Ex: Bar associatif">';
            html += '</div>';
            
            html += '<button class="btn-primary" id="confirmAddFilterBtn">✅ Ajouter le filtre</button>';
            html += '<button class="btn-secondary" id="cancelAddFilterBtn">❌ Annuler</button>';
            
            content.innerHTML = html;
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            document.getElementById('confirmAddFilterBtn').addEventListener('click', () => {
                const emoji = document.getElementById('filterEmoji').value.trim();
                const name = document.getElementById('filterName').value.trim();
                const category = document.getElementById('filterCategory').value;
                
                if (!category) {
                    showNotification('⚠️ Choisissez une catégorie', 'error');
                    return;
                }
                
                if (!name || name.length < 2) {
                    showNotification('⚠️ Le nom doit avoir au moins 2 caractères', 'error');
                    return;
                }
                
                const filterId = name.toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .replace(/[^a-z0-9]/g, '_')
                    .replace(/_+/g, '_')
                    .replace(/^_|_$/g, '');
                
                if (FILTERS_ORDER[category].find(f => f.id === filterId)) {
                    showNotification('⚠️ Ce filtre existe déjà', 'error');
                    return;
                }
                
                const newFilter = {
                    id: filterId,
                    label: emoji ? `${emoji} ${name}` : name
                };
                
                FILTERS_ORDER[category].push(newFilter);
                
                if (!customFilters[category]) {
                    customFilters[category] = [];
                }
                customFilters[category].push(newFilter);
                saveCustomFilters();
                
                generateFormFilters();
                generateSearchFilters();
                
                showNotification(`✅ Filtre "${newFilter.label}" ajouté dans ${category.replace(/_/g, ' ').toUpperCase()} !`);
                closeAddFilterModal();
            });
            
            document.getElementById('cancelAddFilterBtn').addEventListener('click', closeAddFilterModal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeAddFilterModal();
            });
        }

        function closeAddFilterModal() {
            const modal = document.getElementById('addFilterModal');
            if (modal) modal.remove();
        }

        function deleteCustomFilter(categoryKey, filterId) {
            const filter = FILTERS_ORDER[categoryKey].find(f => f.id === filterId);
            if (!filter) return;
            
            if (!confirm(`Supprimer le filtre "${filter.label}" ?\n\nCe filtre sera retiré de toutes les fiches bar.`)) {
                return;
            }
            
            if (customFilters[categoryKey]) {
                customFilters[categoryKey] = customFilters[categoryKey].filter(f => f.id !== filterId);
                if (customFilters[categoryKey].length === 0) {
                    delete customFilters[categoryKey];
                }
                saveCustomFilters();
            }
            
            const index = FILTERS_ORDER[categoryKey].findIndex(f => f.id === filterId);
            if (index !== -1) {
                FILTERS_ORDER[categoryKey].splice(index, 1);
            }
            
            let modifiedCount = 0;
            bars.forEach(bar => {
                const originalLength = bar.features.length;
                bar.features = bar.features.filter(f => f !== filterId);
                if (bar.features.length < originalLength) {
                    modifiedCount++;
                }
            });
            
            if (modifiedCount > 0) {
                saveBars();
            }
            
            selectedSearchFilters = selectedSearchFilters.filter(f => f !== filterId);
            
            generateFormFilters();
            generateSearchFilters();
            renderBarsList();
            updateSelectedFilters();
            performSearch();
            
            let message = `🗑️ Filtre "${filter.label}" supprimé`;
            if (modifiedCount > 0) {
                message += `\n(retiré de ${modifiedCount} bar${modifiedCount > 1 ? 's' : ''})`;
            }
            showNotification(message);
        }

        // UTILITAIRES
        function updateCounts() {
            const count = bars.length;
            document.getElementById('totalBars').textContent = count;
            document.getElementById('barsCount').textContent = count;
        }

        function showNotification(message, type = 'success') {
            const notif = document.createElement('div');
            notif.className = 'notification';
            if (type === 'error') {
                notif.classList.add('error');
            }
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => {
                if (notif.parentNode) notif.remove();
            }, 3000);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}-content`).classList.add('active');
            
            // Tracking changement d'onglet
            if (typeof gtag !== 'undefined') {
                gtag('event', 'page_view', {
                    'page_title': tabName === 'fiche' ? 'Fiche Bar' : 'Recherche',
                    'page_location': window.location.href + '#' + tabName
                });
            }
            
            if (tabName === 'recherche') {
                performSearch();
            }
        }

        // ÉVÉNEMENTS
        function attachEvents() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            
            document.getElementById('newBarBtn').addEventListener('click', showNewBarForm);
            document.getElementById('resetBtn').addEventListener('click', resetToOriginalData);
            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('importBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('fileInput').addEventListener('change', importData);
            document.getElementById('saveBtn').addEventListener('click', saveBar);
            document.getElementById('cancelBtn').addEventListener('click', cancelEdit);
            
            document.getElementById('searchInput').addEventListener('input', performSearch);
            document.getElementById('surpriseMoiBtn').addEventListener('click', surpriseMoi);
            document.getElementById('addFilterSearchBtn').addEventListener('click', () => showAddFilterModal(null));
            
            document.getElementById('formFiltersContainer').addEventListener('click', (e) => {
                if (e.target.classList.contains('add-filter-btn')) {
                    showAddFilterModal(e.target.dataset.category);
                }
            });
        }

        // SURPRENDS-MOI
        function surpriseMoi() {
            if (bars.length === 0) {
                showNotification('❌ Aucun bar disponible', 'error');
                return;
            }
            
            // Tracking Google Analytics
            if (typeof gtag !== 'undefined') {
                gtag('event', 'surprends_moi_click', {
                    'event_category': 'engagement',
                    'event_label': 'Bouton Surprends-moi'
                });
            }
            
            // Réinitialiser les filtres
            selectedSearchFilters = [];
            updateSearchFilterUI();
            updateSelectedFilters();
            document.getElementById('searchInput').value = '';
            
            // Sélectionner un bar aléatoire
            const randomBar = bars[Math.floor(Math.random() * bars.length)];
            
            // Afficher seulement ce bar
            const container = document.getElementById('searchResults');
            const countEl = document.getElementById('resultCount');
            countEl.textContent = 1;
            
            container.innerHTML = '';
            const card = createBarCard(randomBar, false);
            card.style.animation = 'slideIn 0.5s ease';
            container.appendChild(card);
            
            // Tracking du bar suggéré
            if (typeof gtag !== 'undefined') {
                gtag('event', 'bar_suggestion', {
                    'event_category': 'engagement',
                    'event_label': randomBar.name,
                    'bar_type': randomBar.type
                });
            }
            
            showNotification(`🎲 ${randomBar.name} vous attend !`);
        }

        // LANCEMENT
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
